pkgname=spirv-tools-git
pkgver=1.4.321.0
pkgrel=1
arch=(x86_64)
groups=(vulkan-devel)
source=(SPIRV-Tools::git+https://github.com/KhronosGroup/SPIRV-Tools.git)
makedepends=(cmake git ninja python spirv-headers)

pkgver() {
    cd SPIRV-Tools
    printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short=7 HEAD)"
}

build() {
  local cmake_args=(
    -D BUILD_SHARED_LIBS=ON
    -D CMAKE_BUILD_TYPE=Release
    -D CMAKE_INSTALL_PREFIX=/usr
    -D CMAKE_INSTALL_SYSCONFDIR=/etc
    -D CMAKE_SKIP_INSTALL_RPATH=ON
    -D SPIRV-Headers_SOURCE_DIR=/usr
    -D SPIRV_TOOLS_BUILD_STATIC=OFF
    -D SPIRV_WERROR=OFF
  )
  cmake -G Ninja -S SPIRV-Tools -B _build "${cmake_args[@]}"
  cmake --build _build
}

package() {
  depends=(gcc-libs glibc sh)
  provides=(spirv-tools)
  conflicts=(spirv-tools)
  DESTDIR="$pkgdir" cmake --install _build
}