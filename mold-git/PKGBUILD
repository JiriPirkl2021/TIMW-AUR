pkgname=mold-git
pkgver=2.40.4
pkgrel=1
arch=(x86_64)
source=(mold::git+https://github.com/rui314/mold)
makedepends=(cmake ninja git mold python)

pkgver() {
    cd mold
    git describe --long --tags | sed -E 's/^v//;s/([^-]*-g)/r\1/;s/-/./g'
}

build() {
  local cmake_args=(
  -D CMAKE_BUILD_TYPE='Release' \
  -D CMAKE_INSTALL_PREFIX='/usr' \
  -D CMAKE_INSTALL_LIBEXECDIR='lib' \
  -D MOLD_USE_SYSTEM_MIMALLOC=ON \
  -D MOLD_USE_SYSTEM_TBB=ON \
  -D MOLD_LTO=ON \
  -D MOLD_USE_MOLD=ON
  )
  cmake -G Ninja -S mold -B _build "${cmake_args[@]}"
  cmake --build _build
}

package() {
  depends=(glibc gcc-libs libblake3 mimalloc tbb zlib zstd)
  provides=(mold)
  conflicts=(mold)
  DESTDIR="${pkgdir}" cmake --install _build
}
